# 多語言學習器 - 音訊處理流程文檔

## 概述

本文檔詳細描述一個音樂檔案從輸入到輸出的完整處理流程，包括每個步驟產生的中間檔案。

---

## 輸入要求

| 項目 | 說明 |
|------|------|
| 音訊格式 | FLAC（內嵌 LRC 歌詞） |
| 歌詞格式 | LRC 格式，存儲在 FLAC 的 `LYRICS` 標籤中 |
| 歌詞內容 | 原文 + 翻譯（同時間戳兩行） |

---

## 輸出結果

| 項目 | 說明 |
|------|------|
| 音訊格式 | MP3（內嵌 LRC 歌詞） |
| 內容結構 | 原曲片段 → 英文翻譯 TTS → 原曲片段 → 英文翻譯 TTS → ... |
| 歌詞同步 | LRC 格式嵌入 MP3，可在播放器顯示同步字幕 |

---

## 處理流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         輸入檔案                                  │
│                    音樂.flac (內嵌 LRC)                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 1: 解析 LRC 歌詞                                            │
│  ─────────────────────────────────────────────────────────────  │
│  • 從 FLAC 提取 LYRICS 標籤                                       │
│  • 解析時間戳和歌詞內容                                            │
│  • 輸出: 01_original.lrc                                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 2: 翻譯歌詞                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  • 使用 Gemini 2.0 Flash 翻譯成英文                               │
│  • 語言檢測確保翻譯正確                                            │
│  • 輸出: 02_translated.json                                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 3: 合併段落 (≥5秒規則)                                       │
│  ─────────────────────────────────────────────────────────────  │
│  • 將相鄰歌詞合併，確保每段至少 5 秒                                 │
│  • 計算每段的開始/結束時間                                         │
│  • 輸出: 03_segments.txt                                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 4: 分析段落意義                                              │
│  ─────────────────────────────────────────────────────────────  │
│  • 使用 Gemini 判斷每段是否有實際意義                               │
│  • 標記純感嘆詞段落 (如 "啊啊啊", "喔喔喔")                          │
│  • 輸出: 03_segments.txt (更新 IsMeaningful 欄位)                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 5: 切割原始音訊                                              │
│  ─────────────────────────────────────────────────────────────  │
│  • 使用 FFmpeg 按段落時間切割 FLAC                                 │
│  • 每段輸出一個 MP3 檔案                                           │
│  • 輸出: segments/segment_001.mp3, segment_002.mp3, ...          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 6: 生成 TTS 音訊                                            │
│  ─────────────────────────────────────────────────────────────  │
│  • 只為「有意義」的段落生成英文 TTS                                  │
│  • 使用 Gemini 2.5 Flash Preview TTS                             │
│  • 輸出格式: PCM → WAV → MP3                                      │
│  • 輸出: tts/tts_001.mp3, tts_002.mp3, ...                       │
│  • 無意義段落: tts/tts_XXX.mp3 為空檔案或跳過                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 7: 合併最終音訊                                              │
│  ─────────────────────────────────────────────────────────────  │
│  • 交替合併: 原曲段落 + TTS + 原曲段落 + TTS + ...                  │
│  • 使用 FFmpeg concat 合併                                        │
│  • 輸出: output.mp3                                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 8: 生成輸出 LRC                                             │
│  ─────────────────────────────────────────────────────────────  │
│  • 根據合併後的時間重新計算時間戳                                    │
│  • 格式化歌詞 (每行 ≤45 字元)                                      │
│  • 輸出: 04_output.lrc, 04_output_formatted.lrc                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  步驟 9: 嵌入 LRC 到 MP3                                          │
│  ─────────────────────────────────────────────────────────────  │
│  • 使用 Python mutagen 嵌入 ID3 標籤                              │
│  • 標籤: TIT2, TPE1, TALB, TXXX:USLT                             │
│  • 歌詞格式: 每行 ≤45 字元 (播放器相容性)                            │
│  • 輸出: output_final.mp3                                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         最終輸出                                  │
│                    output_final.mp3                              │
│              (含同步歌詞的語言學習音訊)                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 中間檔案詳細說明

### 資料夾結構

```
process/
└── YYYYMMDD_HHMMSS_歌曲名稱/
    ├── 01_original.lrc           # 原始 LRC 歌詞
    ├── 02_translated.json        # 翻譯結果
    ├── 03_segments.txt           # 段落資訊
    ├── 04_output.lrc             # 輸出用 LRC (原始)
    ├── 04_output_formatted.lrc   # 輸出用 LRC (格式化)
    ├── segments/                 # 切割的原曲片段
    │   ├── segment_001.mp3
    │   ├── segment_002.mp3
    │   └── ...
    ├── tts/                      # TTS 音訊
    │   ├── tts_001.mp3
    │   ├── tts_002.mp3
    │   └── ...
    ├── output.mp3                # 合併後音訊 (無歌詞)
    └── output_final.mp3          # 最終輸出 (含歌詞)
```

### 檔案格式說明

#### 01_original.lrc
```
[ti:歌曲標題]
[ar:歌手]
[al:專輯]
[by:]
[offset:0]
[00:01.79] Шаг за 20 руки мокрые
[00:01.79] 20步的距离 潮湿的双手
[00:04.42] Мне не хватит ни сил ни локонов волос
[00:04.42] 我甚至无法抓住你的一缕卷发
...
```

#### 02_translated.json
```json
{
  "lines": [
    {
      "time": "00:01.79",
      "original": "Шаг за 20 руки мокрые",
      "translation": "Step for 20, hands wet"
    },
    ...
  ]
}
```

#### 03_segments.txt
```
Segment 1: 00:01.79 - 00:13.80 (12.01s) [Meaningful: true]
  Original: Шаг за 20 руки мокрые Мне не хватит...
  TTS: Step for 20, hands wet. I won't have enough...

Segment 2: 00:13.80 - 00:20.27 (6.47s) [Meaningful: true]
  Original: Я рассказала маме чёрт возьми...
  TTS: I told mom, damn it...
...
```

#### 04_output_formatted.lrc
```
[ti:Learning Track]
[ar:Multi-Language Learner]
[al:Language Learning]
[by:multilang-learner]
[offset:0]
[00:00.00] Шаг за 20 руки мокрые Мне не хватит
[00:00.00] ни сил ни локонов волос
[00:12.50] Step for 20, hands wet. I won't have
[00:12.50] enough strength or strands of hair
...
```

---

## 技術細節

### 使用的 API 和工具

| 工具/API | 用途 |
|----------|------|
| Gemini 2.0 Flash | 翻譯、段落意義分析 |
| Gemini 2.5 Flash Preview TTS | 英文語音合成 |
| FFmpeg | 音訊切割、格式轉換、合併 |
| Python mutagen | MP3 ID3 標籤處理 |
| whatlanggo | 語言檢測 |

### LRC 嵌入規範

為確保播放器相容性，LRC 必須符合以下規範：

| 項目 | 規範 |
|------|------|
| 每行長度 | ≤ 45 字元 |
| 標頭標籤 | 必須包含 [ti:], [ar:], [al:], [by:], [offset:0] |
| 時間戳格式 | [mm:ss.xx] + 空格 + 歌詞 |
| ID3 標籤 | 必須包含 TIT2, TPE1, TALB |
| 歌詞標籤 | TXXX:USLT (desc='USLT') |

### 段落合併規則

1. 相鄰歌詞時間差 < 5秒 → 合併
2. 合併後段落時長 ≥ 5秒
3. 純感嘆詞段落標記為 `IsMeaningful: false`，不生成 TTS

---

## 範例執行

### 輸入
```
Умри если меня не любишь - Dakooka.flac
- 時長: 2:30
- 歌詞行數: 100 行
- 語言: 俄文 + 中文翻譯
```

### 輸出
```
output_final.mp3
- 時長: 4:24
- 段落數: 23 段
- 內容: 俄文原曲 + 英文 TTS 交替
- 歌詞: 85 行 (格式化後)
```

---

## 注意事項

1. **TTS 跳過規則**: 純感嘆詞段落 (如 "Уо-о-о-о") 不生成 TTS
2. **歌詞行長度**: 超過 45 字元會導致某些播放器無法顯示
3. **ID3 標籤**: 缺少 TIT2/TPE1/TALB 可能導致歌詞無法識別
4. **時間戳精度**: 使用 [mm:ss.xx] 格式 (百分之一秒)
